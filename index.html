<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é±¼å¡˜å…¬çº¦ | é¢†å¯¼åŠ›ä¸å¯æŒç»­å‘å±•è¯¾å ‚</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0ea5e9; --danger: #ef4444; --success: #10b981; --dark: #0f172a; --bg: #f8fafc; --gold: #f59e0b; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); margin: 0; color: #334155; overflow-x: hidden; }
        .hidden { display: none !important; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: 600; transition: 0.2s; padding: 10px 20px; font-size: 14px; }
        button:active { transform: scale(0.98); }
        button:disabled { background: #cbd5e1 !important; cursor: not-allowed; color: #64748b !important; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }

        /* æµ·æ´‹èƒŒæ™¯åŠ¨ç”» */
        .ocean-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, #0284c7, #38bdf8); z-index: 0; overflow: hidden; }
        .fish { position: absolute; font-size: 24px; opacity: 0.8; animation: swim linear infinite; }
        .fish::before { content: 'ğŸ '; }
        .f2::before { content: 'ğŸŸ'; font-size: 30px; } .f3::before { content: 'ğŸ¡'; font-size: 20px; }
        @keyframes swim { from { transform: translateX(-100px) scaleX(-1); } to { transform: translateX(105vw) scaleX(-1); } }

        /* ç™»å½•é¡µ */
        #screen-login { min-height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-card { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 420px; text-align: center; backdrop-filter: blur(10px); border-top: 6px solid var(--primary); }
        .login-title { color: var(--primary); margin: 0 0 10px 0; font-size: 28px; }
        .login-subtitle { color: #64748b; margin-bottom: 25px; font-weight: normal; font-size: 15px; }
        .login-tabs { display: flex; background: #e2e8f0; border-radius: 8px; padding: 4px; margin-bottom: 20px; }
        .login-tabs button { flex: 1; background: transparent; color: #64748b; padding: 10px; font-size: 15px; }
        .login-tabs button.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* æµ…è‰²æ•°æ®å¡ç‰‡ */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; border: 1px solid #cbd5e1; color: var(--dark); padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stat-card h4 { margin: 0; font-size: 13px; color: #64748b; font-weight: 600; }
        .stat-card p { margin: 8px 0 0; font-size: 28px; font-weight: 900; color: var(--primary); }
        
        /* æ•™å¸ˆå¤§å±å¸ƒå±€ */
        #admin-layout { display: grid; grid-template-columns: 3fr 2fr; gap: 20px; }
        .chart-box { height: 280px; position: relative; }
        .table-container { overflow-x: auto; max-height: 300px; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .admin-table th, .admin-table td { text-align: left; padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .admin-table th { background-color: #f8fafc; color: #64748b; font-weight: 600; position: sticky; top: 0; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-ok { background: #dcfce7; color: var(--success); }
        .status-pending { background: #fee2e2; color: var(--danger); }

        /* å´©æºƒå¼¹çª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: flex; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); }
        .modal-content { background: white; padding: 40px; border-radius: 16px; text-align: center; max-width: 450px; border-top: 10px solid var(--danger); box-shadow: 0 20px 40px rgba(0,0,0,0.3); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* å­¦ç”Ÿç«¯ */
        .score-box { background: #f0f9ff; padding: 20px; border-radius: 12px; text-align: center; margin: 20px 0; border: 2px solid #bae6fd; }
        .score-box.bankrupt { background: #fef2f2; border-color: #fca5a5; color: var(--danger); animation: shake 0.5s; }
        .info-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .info-row input { margin: 0; flex: 2; }
        .info-row button { flex: 1; margin: 0; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>
    <div class="ocean-bg" id="bg-anim">
        <div class="fish f1" style="top: 20%; animation-duration: 15s;"></div>
        <div class="fish f2" style="top: 45%; animation-duration: 20s; animation-delay: 2s;"></div>
        <div class="fish f3" style="top: 70%; animation-duration: 12s; animation-delay: 5s;"></div>
        <div class="fish f1" style="top: 85%; animation-duration: 18s; animation-delay: 8s;"></div>
    </div>

    <div class="container">
        <div id="screen-login">
            <div class="login-card">
                <h2 class="login-title">ğŸŸ é±¼å¡˜å…¬çº¦</h2>
                <h3 class="login-subtitle">æ¬¢è¿æ¥åˆ°ã€Šé¢†å¯¼åŠ›ä¸å¯æŒç»­å‘å±•ã€‹çš„è¯¾å ‚</h3>
                
                <div class="login-tabs">
                    <button id="tab-login-stu" class="active" onclick="switchLoginRole('student')">ä¼ä¸šç«¯å…¥å£</button>
                    <button id="tab-login-adm" onclick="switchLoginRole('admin')">æ•™å¸ˆç«¯å…¥å£</button>
                </div>

                <div id="login-stu-area">
                    <input type="text" id="login-user" placeholder="è¯·è¾“å…¥å°ç»„è´¦å·">
                    <input type="password" id="login-pass" placeholder="è¯·è¾“å…¥å¯†ç ">
                    <button onclick="studentLogin()" style="background:var(--primary); color:white; width:100%; margin-top:15px; font-size: 16px; padding: 12px;">æ¥å…¥ç”Ÿæ€ç½‘ç»œ</button>
                </div>
                
                <div id="login-adm-area" class="hidden">
                    <select id="login-room">
                        <option value="2001">æˆ¿é—´ 2001</option><option value="2002">æˆ¿é—´ 2002</option>
                        <option value="2003">æˆ¿é—´ 2003</option><option value="2004">æˆ¿é—´ 2004</option>
                    </select>
                    <input type="password" id="login-adm-pass" placeholder="è¯·è¾“å…¥å¯†ç ">
                    <button onclick="adminLogin()" style="background:var(--dark); color:white; width:100%; margin-top:15px; font-size: 16px; padding: 12px;">å¯åŠ¨æ•™å¸ˆå¤§å±</button>
                </div>
            </div>
        </div>

        <div id="screen-student" class="hidden" style="max-width: 600px; margin: 0 auto;">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding: 15px 20px; background: rgba(255,255,255,0.95);">
                <h3 style="margin:0; color:var(--dark);">ğŸ¢ ä¼ä¸šå†³ç­–æ§åˆ¶å°</h3>
                <button onclick="logout()" style="background:#f1f5f9; color:var(--danger); font-size:12px; padding: 6px 12px;">é€€å‡ºç³»ç»Ÿ</button>
            </div>

            <div class="card">
                <div class="info-row">
                    <input type="text" id="s-team-name-input" placeholder="å…¬å¸åç§°">
                    <button onclick="updateTeamInfo('name')" style="background:#e2e8f0; color:#475569;">æ›´æ–°åç§°</button>
                </div>
                <div class="info-row">
                    <input type="text" id="s-team-members-input" placeholder="ç»„å‘˜å§“å (ç”¨é€—å·åˆ†éš”)">
                    <button onclick="updateTeamInfo('members')" style="background:#e2e8f0; color:#475569;">ç™»è®°ç»„å‘˜</button>
                </div>
                <div id="s-score-container" class="score-box">
                    <div style="font-size: 14px; color: #64748b; font-weight: bold;">ç´¯è®¡å…¬å¸æ”¶ç›Š (å¨)</div>
                    <div id="s-total-catch" style="font-size: 48px; font-weight:900; color:var(--primary); margin: 5px 0;">0</div>
                    <div id="s-bankrupt-msg" class="hidden" style="font-size:16px; font-weight:bold; color:var(--danger);">âš ï¸ èµ„äº§å·²è¢«ç³»ç»Ÿå¼ºåˆ¶æ¸…é›¶ï¼</div>
                </div>
            </div>
            
            <div class="card" style="border-top: 4px solid var(--primary);">
                <h3 style="margin-top:0; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px;">ç¬¬ <span id="s-turn" style="color:var(--primary); font-size:28px;">1</span> è½® ç”Ÿäº§å†³ç­–</h3>
                <p style="font-size: 13px; color: #64748b; background: #f1f5f9; padding: 10px; border-radius: 6px;">â„¹ï¸ èˆ¹é˜Ÿäº§èƒ½ä¸Šé™ä¸º <b>100</b> å¨ã€‚</p>
                <input type="number" id="catch-input" placeholder="è¯·è¾“å…¥æœ¬è½®è®¡åˆ’æ•æé‡ (0-100)..." min="0" max="100" style="font-size: 24px; font-weight: bold; text-align: center; padding: 15px;">
                <button id="btn-submit" onclick="submitDecision()" style="background:var(--success); color:white; width:100%; margin-top:15px; font-size: 18px; padding: 15px;">é”å®šæœ¬è½®äº§é‡</button>
                <p id="submit-msg" style="text-align:center; color:var(--success); font-weight:bold; margin-bottom:0; height: 20px;"></p>
            </div>
        </div>

        <div id="screen-admin" class="hidden">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding: 15px 25px; background: rgba(255,255,255,0.95);">
                <div>
                    <h2 style="margin:0; color:var(--dark);">ğŸŒ æ•™å¸ˆè§†è§’å¤§å±</h2>
                    <span style="color:#64748b; font-size: 14px;">å½“å‰æˆ¿é—´å·: <span id="t-room-tag" style="font-weight:bold; color:var(--primary);"></span></span>
                </div>
                <div style="display:flex; gap:12px; align-items: center;">
                    <span style="background:#e0f2fe; padding:8px 15px; border-radius:8px; font-weight:bold; color:var(--primary);">
                        å·²è¿æ¥: <span id="t-active-teams" style="font-size:18px;">0</span> å®¶
                    </span>
                    <button onclick="initGameSession()" style="background:var(--gold); color:white;">ğŸ”„ åˆå§‹åŒ–/æ–°åœºæ¬¡</button>
                    <button onclick="logout()" style="background:#f1f5f9; color:var(--danger);">é€€å‡ºç³»ç»Ÿ</button>
                </div>
            </div>

            <div id="admin-layout">
                <div class="left-panel">
                    <div class="stat-grid">
                        <div class="stat-card"><h4>å½“å‰è½®æ•°</h4><p id="t-turn">-</p></div>
                        <div class="stat-card"><h4>æœ¬è½®æœŸåˆé±¼é‡</h4><p id="t-fish" style="color:var(--success)">-</p></div>
                        <div class="stat-card"><h4>ç”Ÿæ€ç¯å¢ƒä¸Šé™</h4><p id="t-max">-</p></div>
                        <div class="stat-card"><h4>å†³ç­–è¿›åº¦</h4><p id="t-submitted" style="color:var(--danger)">- / -</p></div>
                    </div>
                    
                    <div class="card">
                        <h4 style="margin-top:0; color:#475569;">ğŸ“‰ å…¨å±€ç”Ÿæ€æ¼”å˜è¶‹åŠ¿</h4>
                        <div class="chart-box"><canvas id="lineChart"></canvas></div>
                    </div>
                    
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h4 style="margin:0; color:#475569;">ğŸ“‹ å›¢é˜ŸçŠ¶æ€ç›‘æ§</h4>
                            <button onclick="downloadCSV()" style="background:var(--primary); color:white; font-size: 12px; padding: 6px 12px;">ğŸ“¥ å¯¼å‡ºæ•°æ®</button>
                        </div>
                        <div class="table-container">
                            <table class="admin-table" id="team-table">
                                <thead><tr><th>å…¬å¸åç§°</th><th>ç»„å‘˜åå•</th><th>ç´¯è®¡æ”¶ç›Š</th><th>æœ¬è½®çŠ¶æ€</th></tr></thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="right-panel">
                    <div class="card" style="border-top: 4px solid var(--danger);">
                        <button id="btn-process" onclick="processRound()" style="background:var(--danger); color:white; width:100%; font-size: 20px; padding: 18px; box-shadow: 0 4px 15px rgba(220,38,38,0.3);">ğŸš¨ ç»“ç®—æœ¬è½®å¹¶ç¹è¡</button>
                        <p style="text-align:center; color:#94a3b8; font-size:12px; margin: 8px 0 0 0;">è¯·åœ¨å·¦ä¾§ç¡®è®¤æ‰€æœ‰ä¼ä¸šå‡å·²æäº¤åå†ç‚¹å‡»</p>
                    </div>

                    <div class="card" style="border-top: 4px solid var(--gold);">
                        <h4 style="margin-top:0; text-align:center;">ğŸ† å…¨çƒæ¸”ä¸šæ’è¡Œæ¦œ</h4>
                        <div style="height:250px; position:relative;"><canvas id="barChart"></canvas></div>
                    </div>
                    <div class="card">
                        <h4 style="margin-top:0; text-align:center;">ğŸ• ä¸Šä¸€è½®æ•æå æ¯”</h4>
                        <div style="height:200px; position:relative;"><canvas id="pieChart"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="collapse-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <h1 style="font-size: 60px; margin: 0 0 10px;">ğŸš¨</h1>
            <h2 style="color: var(--danger); margin-top: 0; font-size: 28px;">ç”Ÿæ€ç³»ç»Ÿå…¨é¢å´©æºƒ</h2>
            <p style="color: #64748b; font-size: 16px; line-height: 1.5;">ç”±äºå…¨ç›˜æåº¦è´ªå©ªçš„è¿‡åº¦æ•æè¡Œä¸ºï¼Œæ€»éœ€æ±‚è¿œè¶…è‡ªç„¶ç¹è¡æé™ï¼Œé±¼å¡˜å·²å½»åº•æ¯ç«­æˆä¸ºæ­»æµ·ã€‚</p>
            <div style="background: #fef2f2; border: 1px dashed #fca5a5; padding: 15px; border-radius: 8px; margin: 25px 0;">
                <b style="color: var(--danger); font-size: 18px;">æ‰€æœ‰ä¼ä¸šç´¯è®¡èµ„äº§å·²è¢«å¼ºåˆ¶æ¸…é›¶ï¼</b>
            </div>
            <button onclick="closeModal()" style="background: var(--dark); color: white; width: 100%; padding: 14px; font-size: 16px;">å…³é—­è­¦æŠ¥ (è¿›å…¥å¤ç›˜é˜¶æ®µ)</button>
        </div>
    </div>

<script>
    const SB_URL = 'https://adjvfvfbjfrtenvbocfw.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkanZmdmZiamZydGVudmJvY2Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzAzNjEsImV4cCI6MjA4MTcwNjM2MX0.Fzd2LU2ueKg0V47NSC9nQY_5hHaFY8SqJuV281iXKag';
    const sb = supabase.createClient(SB_URL, SB_KEY);
    
    let myTeam = null, myRoomId = null, activeTeamsList = [];
    let lineChart, pieChart, barChart;

    // --- ç™»å½•/æ³¨é”€ ---
    function switchLoginRole(role) {
        document.getElementById('login-stu-area').classList.toggle('hidden', role !== 'student');
        document.getElementById('login-adm-area').classList.toggle('hidden', role !== 'admin');
        document.getElementById('tab-login-stu').classList.toggle('active', role === 'student');
        document.getElementById('tab-login-adm').classList.toggle('active', role === 'admin');
    }

    async function studentLogin() {
        const u = document.getElementById('login-user').value.trim();
        const p = document.getElementById('login-pass').value.trim();
        if(!u || !p) return alert("è¯·è¾“å…¥è´¦å·å’Œå¯†ç ");
        const { data } = await sb.from('fishpond_teams').select('*').eq('username', u).eq('password', p).single();
        if (data) { 
            myTeam = data; myRoomId = data.room_id; 
            await sb.from('fishpond_teams').update({ is_active: true }).eq('id', myTeam.id);
            initStudentUI(); 
        } else alert("è´¦å·æˆ–å¯†ç é”™è¯¯");
    }

    function adminLogin() {
        const room = document.getElementById('login-room').value;
        const pwd = document.getElementById('login-adm-pass').value;
        if (pwd === room + "419") { myRoomId = room; initAdminUI(); } else alert("å¯†ç é”™è¯¯");
    }

    async function logout() {
        if(confirm("ç¡®å®šè¦é€€å‡ºç³»ç»Ÿå—ï¼Ÿ")) {
            if(myTeam) await sb.from('fishpond_teams').update({ is_active: false }).eq('id', myTeam.id);
            location.reload();
        }
    }

    // --- å­¦ç”Ÿç«¯é€»è¾‘ ---
    async function initStudentUI() {
        document.getElementById('bg-anim').classList.add('hidden');
        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('screen-student').classList.remove('hidden');
        
        // æ–­ç‚¹é‡è¿ï¼šæ‹‰å–æœ€æ–°æˆ¿é—´çŠ¶æ€
        const { data: room } = await sb.from('fishpond_rooms').select('*').eq('id', myRoomId).single();
        if(room) {
            document.getElementById('s-turn').innerText = room.turn;
            if(room.is_collapsed) showCollapseWarning('student');
        }

        renderStudentData(myTeam);
        // å¦‚æœæœ¬è½®å·²æäº¤ï¼Œé”å®šæŒ‰é’®
        if (myTeam.last_catch !== null) {
            document.getElementById('btn-submit').disabled = true;
            document.getElementById('submit-msg').innerText = "âœ… å†³ç­–å·²ä¸Šä¼ ï¼Œç­‰å¾…ç»“ç®—";
        }
        
        sb.channel('stu_room').on('postgres_changes', { event:'UPDATE', schema:'public', table:'fishpond_rooms', filter:`id=eq.${myRoomId}` }, payload => {
            const r = payload.new;
            document.getElementById('s-turn').innerText = r.turn;
            document.getElementById('btn-submit').disabled = false;
            document.getElementById('submit-msg').innerText = "";
            document.getElementById('catch-input').value = "";
            if (r.is_collapsed) showCollapseWarning('student'); 
            else { document.getElementById('s-score-container').classList.remove('bankrupt'); document.getElementById('s-bankrupt-msg').classList.add('hidden'); }
        }).subscribe();

        sb.channel('stu_team').on('postgres_changes', { event:'UPDATE', schema:'public', table:'fishpond_teams', filter:`id=eq.${myTeam.id}` }, payload => {
            renderStudentData(payload.new);
        }).subscribe();
    }

    function renderStudentData(t) {
        myTeam = t;
        document.getElementById('s-team-name-input').value = t.name;
        document.getElementById('s-team-members-input').value = t.members || '';
        document.getElementById('s-total-catch').innerText = t.total_catch;
    }

    async function updateTeamInfo(field) {
        const inputId = field === 'name' ? 's-team-name-input' : 's-team-members-input';
        const val = document.getElementById(inputId).value.trim();
        if(val === "") return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");
        const updateData = {}; updateData[field] = val;
        await sb.from('fishpond_teams').update(updateData).eq('id', myTeam.id);
        alert("ä¿¡æ¯å·²ä¿å­˜ï¼");
    }

    async function submitDecision() {
        const val = parseInt(document.getElementById('catch-input').value);
        if (isNaN(val) || val < 0 || val > 100) return alert("âŒ è¯·è¾“å…¥ 0-100 ä¹‹é—´çš„æ•´æ•°");
        await sb.from('fishpond_teams').update({ last_catch: val }).eq('id', myTeam.id);
        document.getElementById('btn-submit').disabled = true;
        document.getElementById('submit-msg').innerText = "âœ… å†³ç­–å·²é”å®š";
    }

    // --- æ•™å¸ˆç«¯é€»è¾‘ ---
    async function initAdminUI() {
        document.getElementById('bg-anim').classList.add('hidden');
        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('screen-admin').classList.remove('hidden');
        document.getElementById('t-room-tag').innerText = myRoomId;
        
        initCharts();
        await fetchAdminData();

        sb.channel('adm_room').on('postgres_changes', { event:'*', schema:'public', table:'fishpond_rooms', filter:`id=eq.${myRoomId}` }, () => fetchAdminData()).subscribe();
        sb.channel('adm_team').on('postgres_changes', { event:'*', schema:'public', table:'fishpond_teams', filter:`room_id=eq.${myRoomId}` }, () => fetchAdminData()).subscribe();
    }

    function initCharts() {
        const fontOpts = { size: 11, weight: 'bold' }; const commonOpts = { responsive: true, maintainAspectRatio: false };
        lineChart = new Chart(document.getElementById('lineChart'), { type: 'line', data: { labels: [], datasets: [{ label: 'æœŸåˆé±¼é‡', data: [], borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.1)', fill: true, tension: 0.2, pointRadius: 5 }] }, options: { ...commonOpts, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } });
        pieChart = new Chart(document.getElementById('pieChart'), { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#ef4444','#f97316','#f59e0b','#84cc16','#22c55e','#06b6d4','#3b82f6','#8b5cf6','#d946ef'] }] }, options: { ...commonOpts, plugins: { legend: { position: 'right', labels: { font: { size: 11 } } } } } });
        barChart = new Chart(document.getElementById('barChart'), { type: 'bar', data: { labels: [], datasets: [{ data: [], backgroundColor: '#f59e0b', borderRadius: 4 }] }, options: { ...commonOpts, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true }, y: { ticks: { font: fontOpts } } } } });
    }

    async function fetchAdminData() {
        const { data: room } = await sb.from('fishpond_rooms').select('*').eq('id', myRoomId).single();
        const { data: teams } = await sb.from('fishpond_teams').select('*').eq('room_id', myRoomId).eq('is_active', true).order('name');
        const { data: logs } = await sb.from('fishpond_logs').select('*').eq('room_id', myRoomId).eq('exp_id', room.experiment_id).order('turn');
        
        activeTeamsList = teams;
        document.getElementById('t-active-teams').innerText = teams.length;
        document.getElementById('t-turn').innerText = room.turn;
        document.getElementById('t-fish').innerText = room.current_fish;
        document.getElementById('t-max').innerText = room.max_capacity;
        
        const submittedCount = teams.filter(t => t.last_catch !== null).length;
        document.getElementById('t-submitted').innerText = `${submittedCount} / ${teams.length}`;

        // ã€æ›´æ–°æŠ˜çº¿å›¾ã€‘ï¼šå°†å†å²è®°å½•å’Œâ€œå½“å‰è½®çš„æœŸåˆé±¼é‡â€æ‹¼åˆåœ¨ä¸€èµ·
        let labels = logs.map(l => "R" + l.turn);
        let dataPoints = logs.map(l => l.initial_fish);
        labels.push("R" + room.turn + " (æœ¬è½®)");
        dataPoints.push(room.current_fish);
        lineChart.data.labels = labels; lineChart.data.datasets[0].data = dataPoints; lineChart.update();

        // æŸ±çŠ¶å›¾
        let sortedTeams = [...teams].sort((a, b) => b.total_catch - a.total_catch);
        barChart.data.labels = sortedTeams.map((t, i) => (i===0?"ğŸ¥‡":(i===1?"ğŸ¥ˆ":(i===2?"ğŸ¥‰":""))) + t.name.substring(0,8));
        barChart.data.datasets[0].data = sortedTeams.map(t => t.total_catch); barChart.update();

        // è¡¨æ ¼
        document.querySelector('#team-table tbody').innerHTML = teams.map(t => `<tr>
            <td style="font-weight:bold;">${t.name}</td><td style="color:#64748b; font-size:12px;">${t.members || '-'}</td>
            <td style="font-weight:bold; color:var(--primary);">${t.total_catch}</td>
            <td>${t.last_catch !== null ? '<span class="status-badge status-ok">âœ… å·²æäº¤</span>' : '<span class="status-badge status-pending">â³ ç­‰å¾…ä¸­</span>'}</td>
        </tr>`).join('');

        if (room.is_collapsed && document.getElementById('collapse-modal').classList.contains('hidden')) {
            showCollapseWarning('admin');
        }
    }

    async function initGameSession() {
        if (!confirm("âš ï¸ ç¡®å®šè¦å¼€å¯æ–°åœºæ¬¡å—ï¼Ÿ\næ‰€æœ‰è¿æ¥ä¼ä¸šçš„ç´¯è®¡æ”¶ç›Šå°†æ¸…é›¶ï¼Œç”Ÿæ€èµ„æºå°†åŸºäºå½“å‰è¿æ¥æ•°é‡ç½®ï¼")) return;
        const { data: teams } = await sb.from('fishpond_teams').select('id').eq('room_id', myRoomId).eq('is_active', true);
        let N = teams.length;
        if (N < 2) return alert("âŒ æ— æ³•åˆå§‹åŒ–ï¼šè‡³å°‘éœ€è¦ 2 ä¸ªæ´»è·ƒä¼ä¸šï¼");
        const { data: room } = await sb.from('fishpond_rooms').select('experiment_id').eq('id', myRoomId).single();
        
        // é‡ç½®ç¯å¢ƒ
        await sb.from('fishpond_rooms').update({ experiment_id: (room.experiment_id || 0) + 1, turn: 1, current_fish: N * 300, max_capacity: N * 400, is_collapsed: false }).eq('id', myRoomId);
        await sb.from('fishpond_teams').update({ total_catch: 0, last_catch: null }).eq('room_id', myRoomId);
        
        pieChart.data.labels = []; pieChart.data.datasets[0].data = []; pieChart.update();
        alert(`âœ… æ–°åœºæ¬¡å·²å¼€å¯ï¼ç”Ÿæ€ä¸Šé™å·²è®¾å®šä¸º ${N * 400} å¨ã€‚`);
    }

    async function processRound() {
        if(activeTeamsList.length === 0) return alert("æ²¡æœ‰æ´»è·ƒä¼ä¸šã€‚");
        const submittedCount = activeTeamsList.filter(t => t.last_catch !== null).length;
        
        // é˜²æå‰åˆ¤å†³è¯¯æ“ä½œæ‹¦æˆª
        if (submittedCount < activeTeamsList.length) {
            if(!confirm(`âš ï¸ è­¦å‘Šï¼šè¿˜æœ‰ ${activeTeamsList.length - submittedCount} å®¶ä¼ä¸šæœªæäº¤ï¼\nå¼ºåˆ¶ç»“ç®—ä¼šæŠŠæœªæäº¤ä¼ä¸šçš„æ•æé‡è®°ä¸º 0ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ`)) return;
        }

        const btn = document.getElementById('btn-process'); btn.disabled = true;
        try {
            const { data: teams } = await sb.from('fishpond_teams').select('*').eq('room_id', myRoomId).eq('is_active', true);
            const { data: room } = await sb.from('fishpond_rooms').select('*').eq('id', myRoomId).single();
            if (room.is_collapsed) return alert("å·²æ¯ç«­ã€‚");

            let totalCatch = 0, pieLabels = [], pieValues = [], detailsObj = {};
            for (let t of teams) {
                let val = t.last_catch || 0; 
                totalCatch += val; pieLabels.push(t.name); pieValues.push(val); detailsObj[t.name] = val;
                await sb.from('fishpond_teams').update({ total_catch: t.total_catch + val, last_catch: null }).eq('id', t.id);
            }
            pieChart.data.labels = pieLabels; pieChart.data.datasets[0].data = pieValues; pieChart.update();
            
            // å†™å…¥æ—¥å¿—ï¼ˆåŒ…å«æ˜ç»†ï¼‰
            await sb.from('fishpond_logs').insert({ room_id: myRoomId, exp_id: room.experiment_id, turn: room.turn, initial_fish: room.current_fish, total_catch_all: totalCatch, details: detailsObj });

            if (totalCatch >= room.current_fish) {
                await sb.from('fishpond_rooms').update({ turn: room.turn + 1, current_fish: 0, is_collapsed: true }).eq('id', myRoomId);
                await sb.from('fishpond_teams').update({ total_catch: 0 }).eq('room_id', myRoomId).eq('is_active', true);
            } else {
                let nextFish = Math.min(room.max_capacity, Math.round((room.current_fish - totalCatch) * 1.2));
                await sb.from('fishpond_rooms').update({ turn: room.turn + 1, current_fish: nextFish }).eq('id', myRoomId);
            }
        } catch(e) { console.error(e); }
        finally { btn.disabled = false; }
    }

    // --- é€šç”¨å¼¹çª—ä¸å¯¼å‡º ---
    function showCollapseWarning(role) {
        if (role === 'admin') document.getElementById('collapse-modal').classList.remove('hidden');
        if (role === 'student') {
            document.getElementById('s-score-container').classList.add('bankrupt');
            document.getElementById('s-bankrupt-msg').classList.remove('hidden');
        }
    }
    function closeModal() { document.getElementById('collapse-modal').classList.add('hidden'); }

    async function downloadCSV() {
        if (!confirm("å³å°†å¯¼å‡ºæœ¬æˆ¿é—´ã€æ‰€æœ‰åœºæ¬¡çš„å†å²å®Œæ•´æ•°æ®ã€‘ï¼ŒåŒ…å«æ¯ç»„æ¯è½®çš„å…·ä½“å†³ç­–æ•°å­—ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ")) return;
        const { data: logs } = await sb.from('fishpond_logs').select('*').eq('room_id', myRoomId).order('exp_id').order('turn');
        const { data: teams } = await sb.from('fishpond_teams').select('*').eq('room_id', myRoomId);

        let csv = "\uFEFFã€ç¬¬ä¸€éƒ¨åˆ†ï¼šå…¨å±€åœºæ¬¡ä¸ç”Ÿæ€æ¼”å˜è®°å½•ã€‘\nå®éªŒåœºæ¬¡,è½®æ•°,æœ¬è½®æœŸåˆé±¼é‡,å…¨ç­æ€»æ•æé‡,ç»“ç®—æ—¶é—´,å„ç»„å…·ä½“å†³ç­–è¯¦æƒ…\n";
        logs.forEach(l => {
            let detailStr = l.details ? Object.entries(l.details).map(([k,v]) => `${k}:${v}å¨`).join(" | ") : "æ— æ˜ç»†";
            csv += `${l.exp_id},${l.turn},${l.initial_fish},${l.total_catch_all},${new Date(l.created_at).toLocaleString()},"${detailStr}"\n`;
        });
        csv += "\n\nã€ç¬¬äºŒéƒ¨åˆ†ï¼šä¼ä¸šæ³¨å†Œåå†Œã€‘\nç³»ç»Ÿè´¦å·,å…¬å¸åç§°,ç»„å‘˜åå•,å†å²æœ€é«˜ç´¯è®¡æ”¶ç›Š\n";
        teams.forEach(t => { csv += `${t.username},${t.name},"${t.members || ''}",${t.total_catch}\n`; });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob);
        link.download = `é±¼å¡˜å…¬çº¦_æˆ¿é—´${myRoomId}_å®Œæ•´æ•°æ®æŠ¥è¡¨.csv`; link.click();
    }
</script>
</body>
</html>
