<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é±¼å¡˜å…¬çº¦ | é¢†å¯¼åŠ›ä¸å¯æŒç»­å‘å±•è¯¾å ‚</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0ea5e9; --danger: #ef4444; --success: #10b981; --dark: #0f172a; --bg: #f8fafc; --gold: #f59e0b; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); margin: 0; color: #334155; overflow-x: hidden; }
        .hidden { display: none !important; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; position: relative; z-index: 10; }
        button { cursor: pointer; border: none; border-radius: 8px; font-weight: 600; transition: 0.2s; padding: 10px 20px; font-size: 14px; }
        button:active { transform: scale(0.98); }
        button:disabled { background: #cbd5e1 !important; cursor: not-allowed; color: #64748b !important; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 16px; box-sizing: border-box; transition: 0.3s; }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1); }

        /* === æµ·æ´‹èƒŒæ™¯åŠ¨ç”» (å°é±¼é¡ºå‘æ¸¸åŠ¨ä¿®å¤) === */
        .ocean-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, #0284c7, #38bdf8); z-index: 0; overflow: hidden; }
        .fish { position: absolute; font-size: 24px; opacity: 0.8; animation: swim linear infinite; }
        .fish::before { content: 'ğŸ '; }
        .f2::before { content: 'ğŸŸ'; font-size: 30px; } .f3::before { content: 'ğŸ¡'; font-size: 20px; }
        @keyframes swim { from { transform: translateX(-100px) scaleX(-1); } to { transform: translateX(105vw) scaleX(-1); } }

        /* === é¡¶éƒ¨æ³¨é”€æ  === */
        .nav-bar { display: flex; justify-content: flex-end; align-items: center; margin-bottom: 20px; background: rgba(255,255,255,0.9); padding: 10px 20px; border-radius: 12px; backdrop-filter: blur(5px); }

        /* === ç™»å½•é¡µ === */
        #screen-login { min-height: 80vh; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .login-card { background: rgba(255, 255, 255, 0.95); padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 100%; max-width: 420px; text-align: center; backdrop-filter: blur(10px); border-top: 6px solid var(--primary); }
        .login-title { color: var(--primary); margin: 0 0 10px 0; font-size: 28px; }
        .login-subtitle { color: #64748b; margin-bottom: 25px; font-weight: normal; font-size: 15px; }
        
        /* ç™»å½•å…¥å£åˆ‡æ¢å™¨ */
        .login-tabs { display: flex; background: #e2e8f0; border-radius: 8px; padding: 4px; margin-bottom: 20px; }
        .login-tabs button { flex: 1; background: transparent; color: #64748b; padding: 10px; font-size: 15px; }
        .login-tabs button.active { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* === æ•™å¸ˆç«¯å¸ƒå±€ === */
        #admin-layout { display: grid; grid-template-columns: 3fr 2fr; gap: 20px; }
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--dark); color: white; padding: 15px; border-radius: 10px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .stat-card h4 { margin: 0; font-size: 12px; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card p { margin: 5px 0 0; font-size: 26px; font-weight: 800; }
        .chart-box { height: 280px; position: relative; }

        /* === æ•™å¸ˆç«¯è¡¨æ ¼ === */
        .table-container { overflow-x: auto; }
        .admin-table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        .admin-table th, .admin-table td { text-align: left; padding: 12px; border-bottom: 1px solid #e2e8f0; }
        .admin-table th { background-color: #f8fafc; color: #64748b; font-weight: 600; }
        .status-badge { display: inline-block; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .status-ok { background: #dcfce7; color: var(--success); }
        .status-pending { background: #fee2e2; color: var(--danger); }

        /* === å¤ç›˜é¢æ¿ === */
        #review-panel { border: 3px solid var(--danger); background: #fff1f2; }
        .behavior-box { padding: 12px; margin: 8px 0; background: white; border-left: 5px solid var(--gold); border-radius: 6px; opacity: 0; transition: 0.8s ease-out; font-weight: bold; font-size: 15px; transform: translateX(-20px); }
        .show { opacity: 1 !important; transform: translateX(0) !important; }

        /* === å­¦ç”Ÿç«¯ === */
        .score-box { background: #f0f9ff; padding: 20px; border-radius: 12px; text-align: center; margin: 20px 0; border: 2px solid #bae6fd; }
        .score-box.bankrupt { background: #fef2f2; border-color: #fca5a5; color: var(--danger); animation: shake 0.5s; }
        .info-row { display: flex; gap: 10px; margin-bottom: 10px; }
        .info-row input { margin: 0; flex: 2; }
        .info-row button { flex: 1; margin: 0; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
    </style>
</head>
<body>
    <div class="ocean-bg" id="bg-anim">
        <div class="fish f1" style="top: 20%; animation-duration: 15s;"></div>
        <div class="fish f2" style="top: 45%; animation-duration: 20s; animation-delay: 2s;"></div>
        <div class="fish f3" style="top: 70%; animation-duration: 12s; animation-delay: 5s;"></div>
        <div class="fish f1" style="top: 85%; animation-duration: 18s; animation-delay: 8s;"></div>
    </div>

    <div class="container">
        <div id="nav-container" class="nav-bar hidden">
            <button onclick="logout()" style="background:#cbd5e1; font-size: 13px; color: #475569;">ğŸšª é€€å‡ºç³»ç»Ÿ</button>
        </div>

        <div id="screen-login">
            <div class="login-card">
                <h2 class="login-title">ğŸŸ é±¼å¡˜å…¬çº¦</h2>
                <h3 class="login-subtitle">æ¬¢è¿æ¥åˆ°ã€Šé¢†å¯¼åŠ›ä¸å¯æŒç»­å‘å±•ã€‹çš„è¯¾å ‚</h3>
                
                <div class="login-tabs">
                    <button id="tab-login-stu" class="active" onclick="switchLoginRole('student')">ä¼ä¸šç«¯å…¥å£</button>
                    <button id="tab-login-adm" onclick="switchLoginRole('admin')">æ•™å¸ˆç«¯å…¥å£</button>
                </div>

                <div id="login-stu-area">
                    <input type="text" id="login-user" placeholder="è¯·è¾“å…¥å°ç»„è´¦å·">
                    <input type="password" id="login-pass" placeholder="è¯·è¾“å…¥åˆå§‹æˆæƒç ">
                    <button onclick="studentLogin()" style="background:var(--primary); color:white; width:100%; margin-top:15px; font-size: 16px; padding: 12px;">æ¥å…¥ç”Ÿæ€ç½‘ç»œ</button>
                </div>
                
                <div id="login-adm-area" class="hidden">
                    <select id="login-room">
                        <option value="2001">æˆ¿é—´ 2001</option><option value="2002">æˆ¿é—´ 2002</option>
                        <option value="2003">æˆ¿é—´ 2003</option><option value="2004">æˆ¿é—´ 2004</option>
                    </select>
                    <input type="password" id="login-adm-pass" placeholder="è¯·è¾“å…¥å¯†ç ">
                    <button onclick="adminLogin()" style="background:var(--dark); color:white; width:100%; margin-top:15px; font-size: 16px; padding: 12px;">å¯åŠ¨æ•™å¸ˆå¤§å±</button>
                </div>
            </div>
        </div>

        <div id="screen-student" class="hidden" style="max-width: 600px; margin: 0 auto;">
            <div class="card">
                <h3 style="margin-top:0; color:var(--dark);">ğŸ¢ ä¼ä¸šä¿¡æ¯ç™»è®°</h3>
                <div class="info-row">
                    <input type="text" id="s-team-name-input" placeholder="å…¬å¸åç§°">
                    <button onclick="updateTeamInfo('name')" style="background:#e2e8f0; color:#475569;">æ›´æ–°åç§°</button>
                </div>
                <div class="info-row">
                    <input type="text" id="s-team-members-input" placeholder="ç»„å‘˜å§“å (ç”¨é€—å·åˆ†éš”)">
                    <button onclick="updateTeamInfo('members')" style="background:#e2e8f0; color:#475569;">ç™»è®°ç»„å‘˜</button>
                </div>
                <div id="s-score-container" class="score-box">
                    <div style="font-size: 14px; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">ç´¯è®¡å…¬å¸æ”¶ç›Š (å¨)</div>
                    <div id="s-total-catch" style="font-size: 48px; font-weight:900; color:var(--primary); margin: 10px 0;">0</div>
                    <div id="s-bankrupt-msg" class="hidden" style="font-size:16px; font-weight:bold; color:var(--danger);">âš ï¸ ç”Ÿæ€å´©æºƒï¼Œèµ„äº§å¼ºåˆ¶æ¸…é›¶ï¼</div>
                </div>
            </div>
            
            <div class="card" style="border-top: 4px solid var(--primary);">
                <h3 style="margin-top:0; border-bottom: 1px solid #e2e8f0; padding-bottom: 15px;">
                    ç¬¬ <span id="s-turn" style="color:var(--primary); font-size:28px;">1</span> è½® ç”Ÿäº§å†³ç­–
                </h3>
                <p style="font-size: 14px; color: #64748b; background: #f1f5f9; padding: 10px; border-radius: 8px;">
                    â„¹ï¸ å—åˆ¶äºèˆ¹é˜Ÿäº§èƒ½ï¼Œå•è½®æœ€å¤§æ•æé‡é™åˆ¶ä¸º <b>100</b> å¨ã€‚
                </p>
                <input type="number" id="catch-input" placeholder="è¯·è¾“å…¥æœ¬è½®è®¡åˆ’æ•æé‡ (0-100)..." min="0" max="100" style="font-size: 24px; font-weight: bold; text-align: center; padding: 15px;">
                <button id="btn-submit" onclick="submitDecision()" style="background:var(--success); color:white; width:100%; margin-top:15px; font-size: 18px; padding: 15px;">é”å®šæœ¬è½®äº§é‡</button>
                <p id="submit-msg" style="text-align:center; color:var(--success); font-weight:bold; margin-bottom:0; height: 20px;"></p>
            </div>
        </div>

        <div id="screen-admin" class="hidden">
            <div class="card" style="display:flex; justify-content:space-between; align-items:center; padding: 15px 25px; background: rgba(255,255,255,0.9);">
                <div>
                    <h2 style="margin:0; color:var(--dark);">ğŸŒ å…¨å±€ç”Ÿæ€ç›‘æ§ä¸­å¿ƒ</h2>
                    <span style="color:#64748b; font-size: 14px;">å½“å‰æˆ¿é—´å·: <span id="t-room-tag" style="font-weight:bold; color:var(--primary);"></span></span>
                </div>
                <div style="display:flex; gap:15px; align-items: center;">
                    <span style="background:#e0f2fe; padding:10px 20px; border-radius:30px; font-weight:bold; color:var(--primary); border: 2px solid #bae6fd;">
                        å·²è¿æ¥ä¼ä¸š: <span id="t-active-teams" style="font-size:20px;">0</span> å®¶
                    </span>
                    <button onclick="initGameSession()" style="background:var(--gold); color:white; box-shadow: 0 4px 10px rgba(245, 158, 11, 0.4);">ğŸ”„ 1. åˆå§‹åŒ–/å¼€å¯æ–°åœºæ¬¡</button>
                </div>
            </div>

            <div id="admin-layout">
                <div class="left-panel">
                    <div class="stat-grid">
                        <div class="stat-card"><h4>å½“å‰è½®æ•°</h4><p id="t-turn">-</p></div>
                        <div class="stat-card" style="background:var(--primary)"><h4>æœ¬è½®æœŸåˆé±¼é‡</h4><p id="t-fish">-</p></div>
                        <div class="stat-card" style="background:var(--success)"><h4>ç”Ÿæ€ç¯å¢ƒä¸Šé™</h4><p id="t-max">-</p></div>
                        <div class="stat-card" style="background:var(--dark)"><h4>å†³ç­–è¿›åº¦</h4><p id="t-submitted">- / -</p></div>
                    </div>
                    
                    <div class="card">
                        <h4 style="margin-top:0; color:#475569; display:flex; align-items:center; gap:8px;">ğŸ“‰ å…¨å±€ç”Ÿæ€æ¼”å˜è¶‹åŠ¿ <span style="font-size:12px; font-weight:normal; color:#94a3b8;">(æœŸåˆé±¼é‡)</span></h4>
                        <div class="chart-box"><canvas id="lineChart"></canvas></div>
                    </div>
                    
                    <div class="card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin:0; color:#475569;">ğŸ“‹ å›¢é˜ŸçŠ¶æ€ç›‘æ§ä¸ç®¡ç†</h4>
                            <button onclick="downloadCSV()" style="background:var(--primary); color:white; font-size: 12px; padding: 8px 12px;">ğŸ“¥ å¯¼å‡ºæ•°æ®CSV</button>
                        </div>
                        <div class="table-container">
                            <table class="admin-table" id="team-table">
                                <thead>
                                    <tr>
                                        <th>å…¬å¸åç§°</th>
                                        <th>ç»„å‘˜åå•</th>
                                        <th>ç´¯è®¡æ”¶ç›Š (å¨)</th>
                                        <th>æœ¬è½®çŠ¶æ€</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card" style="background:#fef2f2; border:2px solid #fca5a5;">
                        <h4 style="margin-top:0; color:var(--danger); text-align:center;">âš ï¸ é£é™©æ§åˆ¶æ“ä½œåŒº</h4>
                        <button id="btn-process" onclick="processRound()" style="background:var(--danger); color:white; width:100%; font-size: 20px; padding: 15px; box-shadow: 0 4px 15px rgba(220,38,38,0.4);">ğŸš¨ 2. ç»“ç®—æœ¬è½®å¹¶å¼€å¯ç¹è¡</button>
                        <p style="text-align:center; color:#94a3b8; font-size:12px; margin-bottom:0;">ç‚¹å‡»åå°†ä¸å¯æ’¤é”€ï¼Œè¯·ç¡®è®¤æ‰€æœ‰å°ç»„å·²æäº¤ã€‚</p>
                    </div>
                </div>

                <div class="right-panel">
                    <div class="card" style="border-top: 4px solid var(--gold);">
                        <h4 style="margin-top:0; color:var(--dark); text-align:center; font-weight:800;">ğŸ† å…¨çƒæ¸”ä¸šæ’è¡Œæ¦œ</h4>
                        <div style="height:250px; position:relative;"><canvas id="barChart"></canvas></div>
                    </div>
                    <div class="card">
                        <h4 style="margin-top:0; color:#475569; text-align:center;">ğŸ• ä¸Šä¸€è½®æ•æå æ¯”</h4>
                        <div style="height:200px; position:relative;"><canvas id="pieChart"></canvas></div>
                    </div>
                    
                    <div id="review-panel" class="card hidden">
                        <h2 style="margin-top:0; color:var(--danger); display:flex; align-items:center; gap:10px;">ğŸš¨ é±¼å¡˜æ¯ç«­ï¼æ–‡æ˜å´©å¡Œ</h2>
                        <p style="font-size:14px; color:#64748b; margin-top:0; background:white; padding:10px; border-radius:6px;">ç”Ÿæ€é“¾å·²å½»åº•æ–­è£‚ï¼Œæ‰€æœ‰æ•æäº§å“å˜è´¨ã€‚<b>æ‰€æœ‰ä¼ä¸šç´¯è®¡èµ„äº§å·²è¢«å¼ºåˆ¶æ¸…é›¶ã€‚</b></p>
                        <h4 style="margin: 15px 0 10px; color: var(--dark);">ğŸŒŸ é¢†è¶Šé¢†å¯¼åŠ›åæ€æ—¶åˆ»ï¼š</h4>
                        <div class="behavior-box" id="b1">1. ä»¥èº«ä½œåˆ™ (Model the Way)</div>
                        <div class="behavior-box" id="b2">2. å…±å¯æ„¿æ™¯ (Inspire a Shared Vision)</div>
                        <div class="behavior-box" id="b3">3. æŒ‘æˆ˜ç°çŠ¶ (Challenge the Process)</div>
                        <div class="behavior-box" id="b4">4. ä½¿ä¼—äººè¡Œ (Enable Others to Act)</div>
                        <div class="behavior-box" id="b5">5. æ¿€åŠ±äººå¿ƒ (Encourage the Heart)</div>
                        <button onclick="revealBehaviors()" style="background:var(--gold); color:white; width:100%; margin-top:15px; font-size: 16px; padding: 12px;">ğŸ‘‰ é€é¡¹æ­æ™“å¤ç›˜è¦ç‚¹</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- æ•°æ®åº“é…ç½® ---
    const SB_URL = 'https://adjvfvfbjfrtenvbocfw.supabase.co';
    const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkanZmdmZiamZydGVudmJvY2Z3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYxMzAzNjEsImV4cCI6MjA4MTcwNjM2MX0.Fzd2LU2ueKg0V47NSC9nQY_5hHaFY8SqJuV281iXKag';
    const sb = supabase.createClient(SB_URL, SB_KEY);
    
    let myTeam = null, myRoomId = null, activeTeamsList = [];
    let lineChart, pieChart, barChart;

    // --- ç™»å½•é¡µå…¥å£åˆ‡æ¢ ---
    function switchLoginRole(role) {
        document.getElementById('login-stu-area').classList.toggle('hidden', role !== 'student');
        document.getElementById('login-adm-area').classList.toggle('hidden', role !== 'admin');
        document.getElementById('tab-login-stu').classList.toggle('active', role === 'student');
        document.getElementById('tab-login-adm').classList.toggle('active', role === 'admin');
    }

    async function studentLogin() {
        const u = document.getElementById('login-user').value.trim();
        const p = document.getElementById('login-pass').value.trim();
        if(!u || !p) return alert("è¯·è¾“å…¥è´¦å·å’Œæˆæƒç ");
        const { data, error } = await sb.from('fishpond_teams').select('*').eq('username', u).eq('password', p).single();
        if (data) { 
            myTeam = data; myRoomId = data.room_id; 
            await sb.from('fishpond_teams').update({ is_active: true }).eq('id', myTeam.id);
            initStudentUI(); 
        } else { alert("éªŒè¯å¤±è´¥ï¼šè´¦å·æˆ–æˆæƒç é”™è¯¯"); }
    }

    function adminLogin() {
        const room = document.getElementById('login-room').value;
        const pwd = document.getElementById('login-adm-pass').value;
        if (pwd === room + "419") { myRoomId = room; initAdminUI(); } else { alert("éªŒè¯å¤±è´¥ï¼šå¯†ç é”™è¯¯"); }
    }

    // --- å­¦ç”Ÿç«¯é€»è¾‘ ---
    function initStudentUI() {
        document.getElementById('bg-anim').classList.add('hidden'); // éšè—èƒŒæ™¯åŠ¨ç”»
        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('nav-container').classList.remove('hidden');
        document.getElementById('screen-student').classList.remove('hidden');
        renderStudentData(myTeam);
        
        sb.channel('stu_room').on('postgres_changes', { event:'UPDATE', schema:'public', table:'fishpond_rooms', filter:`id=eq.${myRoomId}` }, payload => {
            const r = payload.new;
            document.getElementById('s-turn').innerText = r.turn;
            document.getElementById('btn-submit').disabled = false;
            document.getElementById('submit-msg').innerText = "";
            document.getElementById('catch-input').value = "";
            
            const scoreBox = document.getElementById('s-score-container');
            const bankruptMsg = document.getElementById('s-bankrupt-msg');
            if (r.is_collapsed) { scoreBox.classList.add('bankrupt'); bankruptMsg.classList.remove('hidden'); } 
            else { scoreBox.classList.remove('bankrupt'); bankruptMsg.classList.add('hidden'); }
        }).subscribe();

        sb.channel('stu_team').on('postgres_changes', { event:'UPDATE', schema:'public', table:'fishpond_teams', filter:`id=eq.${myTeam.id}` }, payload => {
            renderStudentData(payload.new);
        }).subscribe();
    }

    function renderStudentData(t) {
        myTeam = t;
        document.getElementById('s-team-name-input').value = t.name;
        document.getElementById('s-team-members-input').value = t.members || '';
        document.getElementById('s-total-catch').innerText = t.total_catch;
    }

    async function updateTeamInfo(field) {
        const inputId = field === 'name' ? 's-team-name-input' : 's-team-members-input';
        const val = document.getElementById(inputId).value.trim();
        if(val === "") return alert("å†…å®¹ä¸èƒ½ä¸ºç©º");
        const updateData = {}; updateData[field] = val;
        await sb.from('fishpond_teams').update(updateData).eq('id', myTeam.id);
        alert(field === 'name' ? "å…¬å¸åç§°å·²æ›´æ–°ï¼" : "ç»„å‘˜åå•å·²ç™»è®°ï¼");
    }

    async function submitDecision() {
        const val = parseInt(document.getElementById('catch-input').value);
        if (isNaN(val) || val < 0 || val > 100 || document.getElementById('catch-input').value === "") return alert("âŒ å†³ç­–æ— æ•ˆï¼šè¯·è¾“å…¥ 0-100 ä¹‹é—´çš„æ•´æ•°ã€‚");
        
        await sb.from('fishpond_teams').update({ last_catch: val }).eq('id', myTeam.id);
        document.getElementById('btn-submit').disabled = true;
        document.getElementById('submit-msg').innerText = "âœ… å†³ç­–å·²é”å®šå¹¶åŠ å¯†ä¸Šä¼ ";
    }

    // --- æ•™å¸ˆç«¯é€»è¾‘ ---
    async function initAdminUI() {
        document.getElementById('bg-anim').classList.add('hidden');
        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('nav-container').classList.remove('hidden');
        document.getElementById('screen-admin').classList.remove('hidden');
        document.getElementById('t-room-tag').innerText = "è€ƒåœº " + myRoomId;
        
        initCharts();
        await fetchAdminData();

        sb.channel('adm_room').on('postgres_changes', { event:'*', schema:'public', table:'fishpond_rooms', filter:`id=eq.${myRoomId}` }, () => fetchAdminData()).subscribe();
        sb.channel('adm_team').on('postgres_changes', { event:'*', schema:'public', table:'fishpond_teams', filter:`room_id=eq.${myRoomId}` }, () => fetchAdminData()).subscribe();
    }

    function initCharts() {
        const fontOpts = { size: 11, weight: 'bold' };
        const commonOpts = { responsive: true, maintainAspectRatio: false };
        lineChart = new Chart(document.getElementById('lineChart'), { type: 'line', data: { labels: [], datasets: [{ label: 'æœŸåˆé±¼é‡', data: [], borderColor: '#0ea5e9', backgroundColor: 'rgba(14, 165, 233, 0.1)', fill: true, tension: 0.3, pointRadius: 4 }] }, options: { ...commonOpts, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: '#f1f5f9' } }, x: { grid: { display: false } } } } });
        pieChart = new Chart(document.getElementById('pieChart'), { type: 'pie', data: { labels: [], datasets: [{ data: [], backgroundColor: ['#ef4444','#f97316','#f59e0b','#84cc16','#22c55e','#06b6d4','#3b82f6','#8b5cf6','#d946ef'] }] }, options: { ...commonOpts, plugins: { legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 } } } } } });
        barChart = new Chart(document.getElementById('barChart'), { type: 'bar', data: { labels: [], datasets: [{ label: 'ç´¯è®¡æ”¶ç›Š', data: [], backgroundColor: '#f59e0b', borderRadius: 4 }] }, options: { ...commonOpts, indexAxis: 'y', plugins: { legend: { display: false } }, scales: { x: { beginAtZero: true, grid: { color: '#f1f5f9' } }, y: { grid: { display: false }, ticks: { font: fontOpts } } } } });
    }

    async function fetchAdminData() {
        const { data: room } = await sb.from('fishpond_rooms').select('*').eq('id', myRoomId).single();
        const { data: teams } = await sb.from('fishpond_teams').select('*').eq('room_id', myRoomId).eq('is_active', true).order('name');
        const { data: logs } = await sb.from('fishpond_logs').select('*').eq('room_id', myRoomId).eq('exp_id', room.experiment_id).order('turn');
        
        activeTeamsList = teams;
        document.getElementById('t-active-teams').innerText = teams.length;
        document.getElementById('t-turn').innerText = room.turn;
        document.getElementById('t-fish').innerText = room.turn === 1 && logs.length === 0 ? room.current_fish : (logs.length > 0 ? logs[logs.length-1].initial_fish : room.current_fish);
        document.getElementById('t-max').innerText = room.max_capacity;
        
        const submittedCount = teams.filter(t => t.last_catch !== null).length;
        document.getElementById('t-submitted').innerText = `${submittedCount} / ${teams.length}`;

        // æ›´æ–°å›¾è¡¨
        if (logs.length > 0) {
            lineChart.data.labels = logs.map(l => "R" + l.turn);
            lineChart.data.datasets[0].data = logs.map(l => l.initial_fish);
            lineChart.update();
        }
        let sortedTeams = [...teams].sort((a, b) => b.total_catch - a.total_catch);
        barChart.data.labels = sortedTeams.map((t, i) => (i===0?"ğŸ¥‡ ":(i===1?"ğŸ¥ˆ ":(i===2?"ğŸ¥‰ ":""))) + t.name.substring(0,8));
        barChart.data.datasets[0].data = sortedTeams.map(t => t.total_catch);
        barChart.update();

        // æ›´æ–°å›¢é˜ŸçŠ¶æ€è¡¨æ ¼
        const tableBody = document.querySelector('#team-table tbody');
        tableBody.innerHTML = '';
        teams.forEach(t => {
            const statusHtml = t.last_catch !== null 
                ? '<span class="status-badge status-ok">âœ… å·²æäº¤</span>' 
                : '<span class="status-badge status-pending">â³ ç­‰å¾…ä¸­</span>';
            const row = `<tr>
                <td style="font-weight:bold;">${t.name}</td>
                <td style="color:#64748b; font-size:12px;">${t.members || '-'}</td>
                <td style="font-weight:bold; color:var(--primary);">${t.total_catch}</td>
                <td>${statusHtml}</td>
            </tr>`;
            tableBody.innerHTML += row;
        });

        if (room.is_collapsed) document.getElementById('review-panel').classList.remove('hidden');
    }

    function downloadCSV() {
        if (activeTeamsList.length === 0) return alert("æš‚æ— æ•°æ®å¯å¯¼å‡º");
        let csvContent = "\uFEFFå…¬å¸åç§°,ç»„å‘˜åå•,ç´¯è®¡æ”¶ç›Š,å½“å‰çŠ¶æ€\n"; 
        activeTeamsList.forEach(t => {
            const status = t.last_catch !== null ? "å·²æäº¤" : "æœªæäº¤";
            const members = t.members ? `"${t.members}"` : "";
            csvContent += `${t.name},${members},${t.total_catch},${status}\n`;
        });
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `é±¼å¡˜å…¬çº¦_æˆ¿é—´${myRoomId}_æ•°æ®å¯¼å‡º.csv`;
        link.click();
    }

    async function initGameSession() {
        if (!confirm("âš ï¸ é«˜å±æ“ä½œè­¦å‘Šï¼š\nç¡®å®šè¦åˆå§‹åŒ–å¹¶å¼€å¯æ–°åœºæ¬¡å—ï¼Ÿ\n\n1. æ‰€æœ‰å·²è¿æ¥ä¼ä¸šçš„ç´¯è®¡æ”¶ç›Šå°†è¢«æ¸…é›¶ã€‚\n2. ç³»ç»Ÿå°†åŸºäºå½“å‰è¿æ¥æ•°é‡ç½®ç”Ÿæ€èµ„æºä¸Šé™ã€‚")) return;
        const { data: teams } = await sb.from('fishpond_teams').select('id').eq('room_id', myRoomId).eq('is_active', true);
        let N = teams.length;
        if (N < 2) return alert("âŒ æ— æ³•åˆå§‹åŒ–ï¼šè‡³å°‘éœ€è¦ 2 ä¸ªä¼ä¸šè¿æ¥æ‰èƒ½å¼€å¯åšå¼ˆã€‚");
        const { data: room } = await sb.from('fishpond_rooms').select('experiment_id').eq('id', myRoomId).single();
        const nextExp = (room.experiment_id || 0) + 1;
        await sb.from('fishpond_rooms').update({ experiment_id: nextExp, turn: 1, current_fish: N * 300, max_capacity: N * 400, is_collapsed: false }).eq('id', myRoomId);
        await sb.from('fishpond_teams').update({ total_catch: 0, last_catch: null }).eq('room_id', myRoomId);
        lineChart.data.labels = []; lineChart.data.datasets[0].data = []; lineChart.update();
        pieChart.data.labels = []; pieChart.data.datasets[0].data = []; pieChart.update();
        document.getElementById('review-panel').classList.add('hidden');
        alert(`âœ… æ–°åœºæ¬¡å·²å¼€å¯ï¼\nè¯†åˆ«åˆ° ${N} å®¶ä¼ä¸šï¼Œç”Ÿæ€ä¸Šé™å·²è®¾å®šä¸º ${N * 400} å¨ã€‚`);
    }

    async function processRound() {
        if(activeTeamsList.length === 0) return alert("æ²¡æœ‰æ´»è·ƒä¼ä¸šï¼Œæ— æ³•ç»“ç®—ã€‚");
        const btn = document.getElementById('btn-process');
        btn.innerText = "â³ æ­£åœ¨è¿›è¡Œç”Ÿæ€æ¼”ç®—..."; btn.disabled = true;
        try {
            const { data: teams } = await sb.from('fishpond_teams').select('*').eq('room_id', myRoomId).eq('is_active', true);
            const { data: room } = await sb.from('fishpond_rooms').select('*').eq('id', myRoomId).single();
            if (room.is_collapsed) return alert("é±¼å¡˜å·²æ¯ç«­ï¼Œè¯·å‹¿é‡å¤ç»“ç®—ã€‚");

            let totalCatch = 0, pieLabels = [], pieValues = [];
            for (let t of teams) {
                let val = t.last_catch || 0; totalCatch += val; 
                pieLabels.push(t.name); pieValues.push(val);
                await sb.from('fishpond_teams').update({ total_catch: t.total_catch + val, last_catch: null }).eq('id', t.id);
            }
            pieChart.data.labels = pieLabels; pieChart.data.datasets[0].data = pieValues; pieChart.update();
            await sb.from('fishpond_logs').insert({ room_id: myRoomId, exp_id: room.experiment_id, turn: room.turn, initial_fish: room.current_fish, total_catch_all: totalCatch });

            if (totalCatch >= room.current_fish) {
                await sb.from('fishpond_rooms').update({ turn: room.turn + 1, current_fish: 0, is_collapsed: true }).eq('id', myRoomId);
                await sb.from('fishpond_teams').update({ total_catch: 0 }).eq('room_id', myRoomId).eq('is_active', true);
            } else {
                let nextFish = Math.min(room.max_capacity, Math.round((room.current_fish - totalCatch) * 1.2));
                await sb.from('fishpond_rooms').update({ turn: room.turn + 1, current_fish: nextFish }).eq('id', myRoomId);
            }
        } catch(e) { console.error(e); alert("ç»“ç®—å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ"); }
        finally { btn.innerHTML = "ğŸš¨ 2. ç»“ç®—æœ¬è½®å¹¶å¼€å¯ç¹è¡"; btn.disabled = false; }
    }

    function revealBehaviors() {
        ['b1','b2','b3','b4','b5'].forEach((id, i) => setTimeout(() => document.getElementById(id).classList.add('show'), i * 800));
    }
    function logout() { location.reload(); }
</script>
</body>
</html>
